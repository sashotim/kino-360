<html>

<head>
    <title>Kino in 3D</title>
</head>

<body>
    <script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
    <script src="/aframe-look-at-component.js"></script>
    <script>
        // Sets the 'default' eye viewed by camera in non-VR mode

        AFRAME.registerComponent('stereocam', {

            schema: {
                eye: { type: 'string', default: "left" }
            },

            // Cam is not attached on init, so use a flag to do this once at 'tick'

            // Use update every tick if flagged as 'not changed yet'

            init: function() {
                // Flag to register if cam layer has already changed
                this.layer_changed = false;
            },

            tick: function(time) {

                var originalData = this.data;

                // If layer never changed

                if (!this.layer_changed) {

                    // because stereocam component should be attached to an a-camera element
                    // need to get down to the root PerspectiveCamera before addressing layers

                    // Gather the children of this a-camera and identify types

                    var childrenTypes = [];

                    this.el.object3D.children.forEach(function(item, index, array) {
                        childrenTypes[index] = item.type;
                    });

                    // Retrieve the PerspectiveCamera
                    var rootIndex = childrenTypes.indexOf("PerspectiveCamera");
                    var rootCam = this.el.object3D.children[rootIndex];

                    if (originalData.eye === "both") {
                        rootCam.layers.enable(1);
                        rootCam.layers.enable(2);
                    }
                    else {
                        rootCam.layers.enable(originalData.eye === 'left' ? 1 : 2);
                    }
                }
            }

        });




        // Sets the 'default' eye viewed by camera in non-VR mode

        AFRAME.registerComponent('stereo', {

            schema: {
                eye: { type: 'string', default: "left" }
            },

            update: function(oldData) {

                var object3D = this.el.object3D.children[0];
                var data = this.data;

                if (data.eye === "both") {
                    object3D.layers.set(0);
                }
                else {
                    object3D.layers.set(data.eye === 'left' ? 1 : 2);
                }

            },

        });
    </script>
    <a-scene id='scene'>


        <a-assets>
            <img id="sky" src="/R0010192_20181001134315.JPG">
            <video id="video" loop src="public/videos/carotisOP_L.mp4" width="1024" height="512">
            <!--<video id="video" loop autoplay src="/Love 30 DE.mp4">-->
            </video>

            <video id="videoR" loop src="public/videos/carotisOP_R.mp4" width="1024" height="512">
                <!--<video id="video" loop autoplay src="/Love 30 DE.mp4">-->
            </video>
        </a-assets>
        <a-sky src="#sky"></a-sky>

        <!--<a-light color="#333" position="0 5 0" type="ambient" intensity="0.2"></a-light>-->
        <!--<a-light type="point" color="#EEE" intensity="1.0" position="3 3 10"></a-light>-->

        <a-camera position="0 0 0" stereocam="eye:left;" id='camera' zoom='1'>
            <a-entity animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.1 0.1 0.1; to: 1 1 1" animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.1 0.1 0.1" animation__mouseleave="property: scale; startEvents: mouseleave; easing: easeInCubic; dur: 500; to: 1 1 1"
                cursor="fuse: true;" material="color: black; shader: flat" position="0 0 -2.5" geometry="primitive: ring; radiusInner: 0.06; radiusOuter: 0.09" id='cursor'></a-entity>
            <!--  -->
            </a-entity>
        </a-camera>

        <a-entity geometry="primitive: plane; width: 8; height: 4.5" material="src: #video" position="0 0 -6" stereo="eye:left" id='screen'></a-entity>
        <a-entity geometry="primitive: plane; width: 8; height: 4.5" material="src: #videoR" position="0 0 -6" stereo="eye:right"></a-entity>


        <a-entity geometry="primitive: plane; width: 2; height: 4" position="4 0 -3" look-at="[camera]" material="color: yellow">
            <a-entity  text="value:  Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ducimus soluta aperiam dignissimos commodi sunt voluptates nam rem minus animi, consequatur veniam a modi libero perspiciatis iusto maiores autem dolor placeat.;color: black; width: 1.8; wrapCount: 20" ></a-entity>
        </a-entity>


        <!--<a-assets>-->
        <!--    <a-asset-item id="vene" src="scene.gltf"></a-asset-item>-->
        <!--</a-assets>-->

        <!--<a-entity gltf-model="#vene" position='4 0 0'></a-entity>-->
    </a-scene>


    <!--<script src="/aframe-stereo-component.js"></script>-->
    <script>
        //     }, false);

        function getPlatformType() {
            if (navigator.userAgent.match(/mobile/i)) {
                return 'Mobile';
            }
            else if (navigator.userAgent.match(/iPad|Android|Touch/i)) {
                return 'Tablet';
            }
            else {
                return 'Desktop';
            }
        }
        
        function getMobileOperatingSystem() {
                      var userAgent = navigator.userAgent || navigator.vendor || window.opera;
                    
                          // Windows Phone must come first because its UA also contains "Android"
                        if (/windows phone/i.test(userAgent)) {
                            return "Windows Phone";
                        }
                    
                        if (/android/i.test(userAgent)) {
                            return "Android";
                        }
                    
                        // iOS detection from: http://stackoverflow.com/a/9039885/177710
                        if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                            return "iOS";
                        }
                    
                        return "unknown";
                    }

        class Entity {
            constructor(position, geometry, material, id) {
                this.position = position;
                this.geometry = geometry;
                this.material = material;
                this.id = id;
            }
        }

        const renderEntity = (entity, parentId) => {
            const scene = document.querySelector('#' + parentId);

            let tmpEntity = document.createElement('a-entity');
            tmpEntity.setAttribute('position', entity.position);
            tmpEntity.setAttribute('geometry', entity.geometry);
            tmpEntity.setAttribute('material', entity.material);
            tmpEntity.setAttribute('id', entity.id);

            scene.appendChild(tmpEntity);
        };

        const playToggleVideo = () => {
            console.log("play button clicked");
            let video = document.querySelector('#video');
            let videoR = document.querySelector('#videoR');
            
           if (video.paused && videoR.paused) {
               video.play();
               videoR.play()
           } else {
               video.pause();
               videoR.pause();
           }
               
        }

        const stopVideo = () => {
            let video = document.querySelector('#video');
            let videoR = document.querySelector('#videoR');
            if (video.currentTime !== 0 && videoR.currentTime !== 0) {
                video.currentTime = 0;
                video.pause();
                console.log(video.paused ? "videoL is paused at " + video.currentTime : "videoL is NOT paused");
                videoR.currentTime = 0;
                videoR.pause();
                console.log(videoR.paused ? "videoR is paused at " + videoR.currentTime : "videoR is NOT paused");
            }
        };

        const scipAhead = () => {
            let video = document.querySelector('#video');
            let videoR = document.querySelector('#videoR');
            
            video.currentTime = parseFloat(video.currentTime) + 15;
            videoR.currentTime = parseFloat(videoR.currentTime) + 15;
        };

        const replay = () => {
            let video = document.querySelector('#video');
            let videoR = document.querySelector('#videoR');
            
            video.currentTime = parseFloat(video.currentTime) - 15;
            videoR.currentTime = parseFloat(videoR.currentTime) - 15;
        };

        const zoomIn = () => {
            var camera = document.querySelector('#camera');
            camera.setAttribute('zoom', parseFloat(camera.getAttribute('zoom')) + 0.25);
        };

        const zoomOut = () => {
            var camera = document.querySelector('#camera');
            camera.setAttribute('zoom', parseFloat(camera.getAttribute('zoom')) - 0.25);
        };

        const makeControlls = (optionsArr) => {
            // let cursorPosition = event.detail.intersection.point;
            // cursorPosition.z += 1;
            let center = new Entity('0 0 0.1', 'primitive: circle; radius: 0.2', 'color: red', 'center');
            renderEntity(center, 'controllsSquare');
            document.querySelector('#center').addEventListener('click', function() {
                if (visibleControlls) {
                    hideControlls();
                    visibleControlls = false;
                    controllsJustRemoved = true;
                }
            });
            // document.querySelector('#center').setAttribute('look-at', '[camera]');

            let actionCirclesPositions = [
                { name: 'play', position: '0 1.8 0', callback: playToggleVideo },
                { name: 'zoomIn', position: '0 -1.1 0', callback: zoomIn },
                { name: 'zoomOut', position: '0 -0.4 0', callback: zoomOut },
                { name: 'scip', position: '0 1.1 0', callback: scipAhead },
                { name: 'replay', position: '0 0.4 0', callback: replay },
                { name: 'stop', position: '0 -1.8 0', callback: stopVideo }
            ];
            actionCirclesPositions.forEach(function(action) {
                renderEntity(new Entity(action.position, 'primitive: plane; width: 0.5; height: 0.5', 'color: yellow', action.name), 'center');
                let text = document.createElement('a-text');

                document.querySelector('#' + action.name).appendChild(text);
                text.setAttribute('value', action.name);
                text.setAttribute('scale', '0.5');
                text.setAttribute('position', '-0.2 0 0');
                text.setAttribute('color', 'black');
                document.querySelector('#' + action.name).addEventListener('click', action.callback);
            });
        };
        const hideControlls = () => {
            document.querySelector('#center').setAttribute('position', '0 0 -1');
        };

        const showControlls = () => {
            document.querySelector('#center').setAttribute('position', '0 0 0.2');
        };


        const main = () => {

            let controllsSquare = new Entity('-4.25 0 -2.55', 'primitive: plane; width: 1; height: 4.5', 'color: lightgray', 'controllsSquare');
            renderEntity(controllsSquare, 'scene');
            document.querySelector('#controllsSquare').setAttribute('look-at', '[camera]');


            makeControlls('placeholder');
            visibleControlls = true;

            switch (getPlatformType()) {
                case 'Desktop':
                    document.querySelector('#cursor').setAttribute('cursor', 'rayOrigin: mouse; fuse: false');
                    document.querySelector('#cursor').setAttribute('visible', 'false');

                    document.querySelector('#controllsSquare').addEventListener('click', function(e) {
                        if (!visibleControlls && e.target === document.querySelector('#controllsSquare')) {
                            showControlls();
                            visibleControlls = true;
                        }
                    }, false);
                    break;
                case 'Mobile' || 'Tablet':
                    document.querySelector('#cursor').setAttribute('cursor', 'fuse: true');
                    document.querySelector('#controllsSquare').addEventListener('click', function() {
                        if (!visibleControlls && !controllsJustRemoved) {
                            showControlls();
                            visibleControlls = true;
                        }
                    });
                    
                    if(getMobileOperatingSystem() === 'iOS'){
                        var scene = document.querySelector('a-scene');
                          scene.addEventListener('enter-vr', (event) => {
                            window.scrollTop = 0;
                          });
                    }
                    
                    

                    document.querySelector('#controllsSquare').addEventListener('mouseleave', function() {
                        controllsJustRemoved = false;
                    });
                    break;
            }
        };


        let visibleControlls = false;
        let controllsJustRemoved = false;
        main();
    </script>
</body>

</html>
