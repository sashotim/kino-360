<html>

<head>
    <title>Kino in 3D</title>
    <script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
</head>

<body>
    <a-scene id='scene'>
        <video id="video" loop autoplay src="/Love 30 DE.mp4">
        </video>

        <a-entity geometry="primitive: sphere;
                      radius: 100;
                      segmentsWidth: 64;
                      segmentsHeight: 64;" material="shader: flat; color: darkblue;" scale="-1 1 1">
        </a-entity>

        <a-light color="#333" position="0 5 0" type="ambient" intensity="0.2"></a-light>
        <a-light type="point" color="#EEE" intensity="1.0" position="3 3 10"></a-light>

        <a-camera position="0 0 0" stereocam="eye:left;" id='camera' zoom='1'>
            <a-entity animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.1 0.1 0.1; to: 1 1 1" animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.1 0.1 0.1" animation__mouseleave="property: scale; startEvents: mouseleave; easing: easeInCubic; dur: 500; to: 1 1 1"
                cursor="fuse: true;" material="color: black; shader: flat" position="0 0 -2.5" geometry="primitive: ring; radiusInner: 0.06; radiusOuter: 0.09" id='cursor'></a-entity>
            <!--  -->
            </a-entity>
        </a-camera>

        <a-entity geometry="primitive: plane; width: 8; height: 4.5" material="src: #video" position="0 0 -3" stereo="eye:left" id='screen'></a-entity>
        <a-entity geometry="primitive: plane; width: 8; height: 4.5" material="src: #video" position="0 0 -3" stereo="eye:right"></a-entity>
    </a-scene>

    <script src="https://unpkg.com/aframe-look-at-component@0.5.1/dist/aframe-look-at-component.min.js"></script>
    <script>
        //     }, false);

        function getPlatformType() {
            if (navigator.userAgent.match(/mobile/i)) {
                return 'Mobile';
            }
            else if (navigator.userAgent.match(/iPad|Android|Touch/i)) {
                return 'Tablet';
            }
            else {
                return 'Desktop';
            }
        }

        class Entity {
            constructor(position, geometry, material, id) {
                this.position = position;
                this.geometry = geometry;
                this.material = material;
                this.id = id;
            }
        }

        const renderEntity = (entity, parentId) => {
            const scene = document.querySelector('#' + parentId);

            let tmpEntity = document.createElement('a-entity');
            tmpEntity.setAttribute('position', entity.position);
            tmpEntity.setAttribute('geometry', entity.geometry);
            tmpEntity.setAttribute('material', entity.material);
            tmpEntity.setAttribute('id', entity.id);

            scene.appendChild(tmpEntity);
        };

        const playToggleVideo = () => {
            let video = document.querySelector('video');
            video.paused ? video.play() : video.pause();
        }
        const stopVideo = () => {
            let video = document.querySelector('video');
            if (video.currentTime !== 0) {
                video.currentTime = 0;
                video.pause();
            }
        };

        const scipAhead = () => {
            let video = document.querySelector('video');
            video.currentTime = parseFloat(video.currentTime) + 15;
        };

        const replay = () => {
            let video = document.querySelector('video');
            video.currentTime = parseFloat(video.currentTime) - 15;
        };

        const zoomIn = () => {
            var camera = document.querySelector('#camera');
            camera.setAttribute('zoom', parseFloat(camera.getAttribute('zoom')) + 0.25);
        };

        const zoomOut = () => {
            var camera = document.querySelector('#camera');
            camera.setAttribute('zoom', parseFloat(camera.getAttribute('zoom')) - 0.25);
        };

        const makeControlls = (optionsArr) => {
            // let cursorPosition = event.detail.intersection.point;
            // cursorPosition.z += 1;
            let center = new Entity('0 0 0.1', 'primitive: circle; radius: 0.2', 'color: red', 'center');
            renderEntity(center, 'controllsSquare');
            document.querySelector('#center').addEventListener('click', function() {
                if (visibleControlls) {
                    console.log('controlls should disappear')
                    hideControlls();
                    visibleControlls = false;
                    controllsJustRemoved = true;
                }
            });
            // document.querySelector('#center').setAttribute('look-at', '[camera]');

            let actionCirclesPositions = [
                { name: 'play', position: '0 1.8 0', callback: playToggleVideo },
                { name: 'zoomIn', position: '0 -1.1 0', callback: zoomIn },
                { name: 'zoomOut', position: '0 -0.4 0', callback: zoomOut },
                { name: 'scip', position: '0 1.1 0', callback: scipAhead },
                { name: 'replay', position: '0 0.4 0', callback: replay },
                { name: 'stop', position: '0 -1.8 0', callback: stopVideo }
            ];
            actionCirclesPositions.forEach(function(action) {
                renderEntity(new Entity(action.position, 'primitive: plane; width: 0.5; height: 0.5', 'color: yellow', action.name), 'center');
                let text = document.createElement('a-text');

                document.querySelector('#' + action.name).appendChild(text);
                text.setAttribute('value', action.name);
                text.setAttribute('scale', '0.5');
                text.setAttribute('position', '-0.2 0 0');
                text.setAttribute('color', 'black');
                document.querySelector('#' + action.name).addEventListener('click', action.callback);
            });
        };

        const hideControlls = () => {
            document.querySelector('#center').setAttribute('position', '0 0 -1');
        };

        const showControlls = () => {
            document.querySelector('#center').setAttribute('position', '0 0 0.2');
        };


        const main = () => {

            let controllsSquare = new Entity('-4.25 0 -2.55', 'primitive: plane; width: 1; height: 4.5', 'color: transparent', 'controllsSquare');
            renderEntity(controllsSquare, 'scene');
            document.querySelector('#controllsSquare').setAttribute('look-at', '[camera]');


            makeControlls('placeholder');
            visibleControlls = true;

            switch (getPlatformType()) {
                case 'Desktop':
                    document.querySelector('#cursor').setAttribute('cursor', 'rayOrigin: mouse; fuse: false');
                    document.querySelector('#cursor').setAttribute('visible', 'false');

                    document.querySelector('#controllsSquare').addEventListener('click', function(e) {
                        if (!visibleControlls && e.target === document.querySelector('#controllsSquare')) {
                            console.log('controlls should show')
                            showControlls();
                            visibleControlls = true;
                        }
                    }, false);
                break;
                case 'Mobile' || 'Tablet':
                    document.querySelector('#cursor').setAttribute('cursor', 'fuse: true');
                    document.querySelector('#controllsSquare').addEventListener('click', function() {
                        if (!visibleControlls && !controllsJustRemoved) {
                            showControlls();
                            visibleControlls = true;
                        }
                    });

                    document.querySelector('#controllsSquare').addEventListener('mouseleave', function() {
                        controllsJustRemoved = false;
                    });
                    break;
            }
        };


        let visibleControlls = false;
        let controllsJustRemoved = false;
        main();
    </script>
</body>

</html>
